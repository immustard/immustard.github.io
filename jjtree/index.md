# JJTree


&lt;!--more--&gt;

&gt; ä¼ é€é—¨: [JJTree](https://javacc.github.io/javacc/documentation/jjtree.html)

## æ¦‚è¿°
JJTree æ˜¯ JavaCC çš„é¢„å¤„ç†å™¨, å¯åœ¨ JavaCC æºä»£ç çš„ä¸åŒä½ç½®æ’å…¥è§£æžæ ‘æž„å»ºæ“ä½œ. JJTree çš„è¾“å‡ºé€šè¿‡ JavaCC è¿è¡Œä»¥åˆ›å»ºè§£æžå™¨. æ­¤æ–‡æ¡£æè¿°äº†å¦‚ä½•ä½¿ç”¨ JJTree, ä»¥åŠå¦‚ä½•å°†è§£æžå™¨è¿žæŽ¥åˆ° JJTree. 

é»˜è®¤æƒ…å†µä¸‹, JJTree ç”Ÿæˆä»£ç æ¥ä¸ºè¯­è¨€ä¸­çš„æ¯ä¸ªéžç»ˆèŠ‚ç‚¹ç»“æž„è§£æžä¹¦èŠ‚ç‚¹. ä½†æ˜¯å¯ä»¥ä¿®æ”¹è¿™ä¸ªè¡Œä¸º, ä¸ºäº†æŸäº›éžç»ˆèŠ‚ç‚¹ä¸ä¼šç”ŸæˆèŠ‚ç‚¹, æˆ–è€…ä¸ºç”Ÿäº§æ‰©å±•çš„ä¸€éƒ¨åˆ†ç”ŸæˆèŠ‚ç‚¹. 

JJTree å®šä¹‰äº†ä¸€ä¸ª Java æŽ¥å£ `Node` , å¹¶ä¸”æ‰€æœ‰è§£æžæ ‘èŠ‚ç‚¹éƒ½å¿…é¡»å®žçŽ°å®ƒ. è¿™ä¸ªæŽ¥å£æä¾›äº†ä¾‹å¦‚è®¾ç½®çˆ¶èŠ‚ç‚¹ã€æ·»åŠ å’Œæ£€ç´¢å­èŠ‚ç‚¹ç­‰æ“ä½œçš„æ–¹æ³•. 

JJTree ä»¥ä¸¤ç§æ¨¡å¼ä¹‹ä¸€è¿è¡Œ, ç®€å•æ¨¡å¼å’Œå¤šæ¨¡å¼ (éœ€è¦æ›´å¥½çš„æœ¯è¯­). åœ¨ç®€å•æ¨¡å¼ä¸‹, æ¯ä¸ªè§£æžæ ‘èŠ‚ç‚¹éƒ½æ˜¯å…·ä½“ç±»åž‹çš„ `SimpleNode`, åœ¨å¤šæ¨¡å¼ä¸‹, è§£æžæ ‘èŠ‚ç‚¹çš„ç±»åž‹æºè‡ªèŠ‚ç‚¹çš„åç§°. å¦‚æžœä¸æä¾›èŠ‚ç‚¹ç±»çš„å®žçŽ°, é‚£ä¹ˆ JJTree ä¼šç”ŸæˆåŸºäºŽ `SimpleNode` çš„ç¤ºä¾‹å®žçŽ°. ä¹‹åŽå¯ä»¥ä¿®æ”¹è¯¥å®žçŽ°æ¥è¿›è¡Œé€‚é…. 

è™½ç„¶ JavaCC æ˜¯ä¸€ä¸ªè‡ªä¸Šè€Œä¸‹çš„è§£æžå™¨, ä½†æ˜¯ JJTree æ˜¯è‡ªä¸‹è€Œä¸Šåœ°æž„é€ è§£æžæ ‘. ä¸ºæ­¤, å®ƒä½¿ç”¨ä¸€ä¸ªå †æ ˆ, åœ¨åˆ›å»ºèŠ‚ç‚¹åŽæŽ¨é€èŠ‚ç‚¹. å½“å®ƒä¸ºå®ƒä»¬æ‰¾åˆ°çˆ¶çº§æ—¶, å®ƒä¼šä»Žå †æ ˆä¸­å¼¹å‡º (pop) å­çº§å¹¶å°†å®ƒä»¬æ·»åŠ åˆ°çˆ¶çº§, å¹¶ä¸”æœ€åŽæŽ¨é€æ–°çš„çˆ¶èŠ‚ç‚¹æœ¬èº«. å †æ ˆæ˜¯å¼€æ”¾çš„, è¿™æ„å‘³ç€å¯ä»¥ä»Žè¯­æ³•æ“ä½œä¸­è®¿é—®å®ƒ: å¯ä»¥ç”¨è®¤ä¸ºåˆé€‚çš„æ–¹å¼è¿›è¡ŒæŽ¨é€ (push), å¼¹å‡º (pop)å’Œå…¶ä»–æ–¹å¼æ“ä½œå…¶å†…å®¹ (è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ [èŠ‚ç‚¹èŒƒå›´å’Œç”¨æˆ·æ“ä½œ](#èŠ‚ç‚¹èŒƒå›´å’Œç”¨æˆ·æ“ä½œ) )

JJTree æä¾›äº†ä¸¤ç§åŸºæœ¬ç±»åž‹çš„èŠ‚ç‚¹çš„è£…é¥°, ä»¥åŠä¸€äº›è¯­æ³•é€Ÿè®°ä»¥æ–¹ä¾¿å®ƒä»¬çš„ä½¿ç”¨. 

#### ç¡®å®šèŠ‚ç‚¹
ä¸€ä¸ªç¡®å®šèŠ‚ç‚¹æ˜¯ç”¨ç‰¹å®šæ•°é‡çš„å­èŠ‚ç‚¹æž„æˆçš„. è®¸å¤šèŠ‚ç‚¹ä»Žå †æ ˆä¸­å¼¹å‡ºå¹¶æˆä¸ºæ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹, ç„¶åŽå°†å…¶æŽ¨é€åˆ°å †æ ˆæœ¬èº«ä¸Š. 

å¯ä»¥æ ‡è®°ä¸€ä¸ªç¡®å®šèŠ‚ç‚¹, ç±»ä¼¼è¿™æ ·: 
```
#ADefiniteNode(INTEGER EXPRESSION)
```

ç¡®å®šèŠ‚ç‚¹æè¿°ç¬¦è¡¨è¾¾å¼å¯ä»¥æ˜¯ä»»ä½•æ•´æ•°è¡¨è¾¾å¼, å°½ç®¡æ–‡å­—æ•´æ•°å¸¸é‡æ˜¯è¿„ä»Šä¸ºæ­¢æœ€å¸¸è§çš„è¡¨è¾¾å¼. 

#### æ¡ä»¶èŠ‚ç‚¹
å½“ä¸”ä»…å½“æ¡ä»¶è®¡ç®—ä¸ºçœŸ (`true`) æ—¶æ‰ä½¿ç”¨å…¶èŠ‚ç‚¹èŒƒå›´å†…è¢«æŽ¨é€åˆ°å †æ ˆçš„æ‰€æœ‰å­èŠ‚ç‚¹æž„é€ æ¡ä»¶èŠ‚ç‚¹. å¦‚æžœè®¡ç®—æ¡ä»¶ä¸ºå‡ (`false`) æ—¶, è¯¥èŠ‚ç‚¹ä¸ä¼šè¢«æž„é€ , å¹¶ä¸”å…¶æ‰€æœ‰å­èŠ‚ç‚¹ä¼šç•™åœ¨èŠ‚ç‚¹å †æ ˆä¸­. 

å¯ä»¥æ ‡è®°ä¸€ä¸ªæ¡ä»¶èŠ‚ç‚¹, ç±»ä¼¼è¿™æ ·: 
```
#ConditionalNode(BOOLEAN EXPRESSION)
```

æ¡ä»¶èŠ‚ç‚¹æè¿°ç¬¦è¡¨è¾¾å¼å¯ä»¥æ˜¯ä»»ä½•å¸ƒå°”è¡¨è¾¾å¼. 

 æ¡ä»¶èŠ‚ç‚¹æœ‰ä¸¤ç§å¸¸è§çš„ç®€å†™:
 	1. ä¸å®šèŠ‚ç‚¹ (Indefinite nodes)
		```
		#IndefiniteNode is short for #IndefiniteNode(true)
		```
	2. å¤§äºŽèŠ‚ç‚¹ (Greater-than nodes)
		```
		#GTNode(&gt;1) is short for #GTNode(jjtree.arity() &gt; 1)
		```
	
ä¸å®šèŠ‚ç‚¹é€Ÿè®° `(1)` åœ¨åŽé¢è·Ÿç€å¸¦æ‹¬å·çš„å±•å¼€æ—¶å¯èƒ½ä¼šå¯¼è‡´ JJTree æºä¸­çš„æ­§ä¹‰. åœ¨è¿™ç§æƒ…å†µä¸‹, é€Ÿè®°å¿…é¡»æ›¿æ¢ä¸ºå®Œæ•´è¡¨è¾¾å¼:
```
( ... ) #N ( a() )
```
ä¸Šé¢è¿™ä¸ªæ˜¯æœ‰æ­§ä¹‰çš„, æ‰€ä»¥å¿…é¡»ä½¿ç”¨æ˜¾ç¤ºæ¡ä»¶:
```
( ... ) #N(true) ( a() )
```

**æ³¨æ„: èŠ‚ç‚¹æè¿°ç¬¦è¡¨è¾¾å¼ä¸åº”è¯¥æœ‰å‰¯ä½œç”¨. JJTreeæ²¡æœ‰æŒ‡å®šè¡¨è¾¾å¼å°†è¢«è®¡ç®—å¤šå°‘æ¬¡.**

é»˜è®¤æƒ…å†µä¸‹, JJTree å°†æ¯ä¸ªéžç»ˆèŠ‚ç‚¹è§†ä¸ºä¸å®šèŠ‚ç‚¹, å¹¶ä»Žå…¶ç”Ÿäº§åç§°æ´¾ç”ŸèŠ‚ç‚¹çš„åç§°. å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ä¸ºå…¶å‘½å: 
```
void P1() #MyNode : { ... } { ... }
```

å½“è§£æžå™¨è¯†åˆ«å‡ºä¸€ä¸ª `P1` éžç»ˆèŠ‚ç‚¹æ—¶, å®ƒä¼šå¼€å§‹ä¸€ä¸ªä¸å®šèŠ‚ç‚¹. å®ƒæ ‡è®°å †æ ˆ, ä»¥ä¾¿åœ¨ `P1` æ‰©å±•ä¸­ç”±éžç»ˆèŠ‚ç‚¹åˆ›å»ºå¹¶æŽ¨é€åˆ°å †æ ˆä¸Šçš„ä»»ä½•è§£æžæ ‘èŠ‚ç‚¹éƒ½å°†è¢«å¼¹å‡ºå¹¶æˆä¸ºèŠ‚ç‚¹ `MyNode` çš„å­èŠ‚ç‚¹. 

å¦‚æžœè¦ç¦æ­¢ä¸ºç”Ÿäº§åˆ›å»ºèŠ‚ç‚¹, å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­æ³•: 
```
void P2() #void : { ... } { ... }
```

çŽ°åœ¨, åœ¨ `P2` çš„æ‰©å±•ä¸­ç”±éžç»ˆèŠ‚ç‚¹æŽ¨é€çš„ä»»ä½•è§£æžæ ‘èŠ‚ç‚¹éƒ½å°†ä¿ç•™åœ¨å †æ ˆä¸Š, ä»¥ä¾¿å¼¹å‡ºå¹¶ä½¿å…¶æˆä¸ºæ ‘ä¸Šæ›´å‘ä¸Šçš„ç”Ÿäº§å­èŠ‚ç‚¹. å¯ä»¥ä½¿ç”¨ `NODE_DEFAULT_VOID` é€‰é¡¹å°†æ­¤è®¾ç½®ä¸ºæœªè£…é¥°èŠ‚ç‚¹çš„é»˜è®¤è¡Œä¸º. 

```
void P3() : {} {
	P4() ( P5() )&#43; P6()
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­, å¼€å§‹ä¸€ä¸ªä¸å®šèŠ‚ç‚¹ `P3`, æ ‡è®°å †æ ˆ, ç„¶åŽè§£æžä¸€ä¸ª `P4` èŠ‚ç‚¹ã€ä¸€ä¸ªæˆ–å¤šä¸ª `P5` èŠ‚ç‚¹å’Œä¸€ä¸ª `P6` èŠ‚ç‚¹. 

å¯ä»¥è¿›ä¸€æ­¥è‡ªå®šä¹‰ç”Ÿæˆçš„æ ‘: 
```
void P3() : {} {
	P4() ( P5() )&#43; #ListOfP5s P6()
}
```

çŽ°åœ¨, `P3` èŠ‚ç‚¹å°†æœ‰ä¸€ä¸ª `P4` èŠ‚ç‚¹ã€ä¸€ä¸ª `ListOfP5s` èŠ‚ç‚¹å’Œä¸€ä¸ª `P6` èŠ‚ç‚¹ä½œä¸ºå­èŠ‚ç‚¹. `#Name` æž„é€ å……å½“åŽç¼€è¿ç®—ç¬¦, å…¶ä½œç”¨åŸŸæ˜¯ç´§æŽ¥åœ¨å‰çš„æ‰©å±•å•å…ƒ. 

### èŠ‚ç‚¹èŒƒå›´å’Œç”¨æˆ·æ“ä½œ
æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¸Žä¸€ä¸ªèŠ‚ç‚¹ä½œç”¨åŸŸ (*node scope*) ç›¸å…³è”. æ­¤èŒƒå›´å†…çš„ç”¨æˆ·æ“ä½œå¯ä»¥é€šè¿‡ä½¿ç”¨ç‰¹æ®Šæ ‡è¯†ç¬¦ `jjtThis` æ¥è®¿é—®æ­£åœ¨æž„å»ºçš„èŠ‚ç‚¹, ä»¥å¼•ç”¨è¯¥èŠ‚ç‚¹. è¯¥æ ‡è¯†ç¬¦è¢«éšå¼å£°æ˜Žä¸ºè¯¥èŠ‚ç‚¹çš„æ­£ç¡®ç±»åž‹, å› æ­¤å¯ä»¥è½»æ¾åœ°è®¿é—®è¯¥èŠ‚ç‚¹æ‹¥æœ‰çš„ä»»ä½•å­—æ®µå’Œæ–¹æ³•. 

ä½œç”¨åŸŸæ˜¯ç´§é åœ¨èŠ‚ç‚¹ä¿®é¥°ä¹‹å‰çš„æ‰©å±•å•å…ƒ. è¿™å¯ä»¥æ˜¯å¸¦æ‹¬å·çš„è¡¨è¾¾å¼. å½“å¯¹ç”Ÿäº§ç­¾åè¿›è¡Œè£…é¥°æ—¶ (å¯èƒ½éšå¼å¸¦æœ‰é»˜è®¤èŠ‚ç‚¹), ä½œç”¨åŸŸæ˜¯ç”Ÿäº§çš„æ•´ä¸ªå³ä¾§, åŒ…æ‹¬å…¶å£°æ˜Žå—. 

è¿˜å¯ä»¥åœ¨æ‰©å±•å¼•ç”¨çš„å·¦ä¾§ä½¿ç”¨æ¶‰åŠ `jjtThis` çš„è¡¨è¾¾å¼. 

ðŸŒ°:
```
... ( jjtThis.my_foo = foo() ) #Baz ...
```

è¿™é‡Œçš„ `jjtThis` æŒ‡å‘çš„æ˜¯ä¸€ä¸ª `Baz` èŠ‚ç‚¹, ä»–æœ‰ä¸€ä¸ªåä¸º `my_foo` çš„å­—æ®µ. å°†è§£æžç”Ÿæˆçš„ `foo()` çš„ç»“æžœèµ‹ç»™ `myfoo`. 

èŠ‚ç‚¹èŒƒå›´å†…çš„æœ€ç»ˆç”¨æˆ·æ“ä½œä¸Žæ‰€æœ‰å…¶ä»–æ“ä½œä¸åŒ. å½“å…¶ä¸­çš„ä»£ç æ‰§è¡Œæ—¶, èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å·²ç»ä»Žå †æ ˆä¸­å¼¹å‡ºå¹¶æ·»åŠ åˆ°èŠ‚ç‚¹ä¸­, èŠ‚ç‚¹æœ¬èº«å·²è¢«æŽ¨é€åˆ°å †æ ˆä¸­. çŽ°åœ¨, å¯ä»¥é€šè¿‡èŠ‚ç‚¹çš„æ–¹æ³• (æ¯”å¦‚ `jjtGetChild()`) æ¥è®¿é—®å­èŠ‚ç‚¹. 

é™¤æœ€åŽä¸€ä¸ªæ“ä½œä¹‹å¤–çš„å…¶ä»–ç”¨æˆ·æ“ä½œåªèƒ½è®¿é—®å †æ ˆä¸Šçš„å­çº§. å®ƒä»¬è¿˜æ²¡æœ‰è¢«åŠ å…¥åˆ°èŠ‚ç‚¹ä¸­, æ‰€ä»¥è¿˜ä¸èƒ½é€šè¿‡èŠ‚ç‚¹çš„æ–¹æ³•è¿›è¡Œè®¿é—®. å¦‚æžœæ¡ä»¶èŠ‚ç‚¹çš„èŠ‚ç‚¹æè¿°ç¬¦è¡¨è¾¾å¼çš„è®¡ç®—ç»“æžœä¸º `false`, åˆ™ä¸ä¼šå°†å…¶æ·»åŠ åˆ°å †æ ˆä¸­, ä¹Ÿä¸ä¼šå‘å…¶æ·»åŠ å­èŠ‚ç‚¹. æ¡ä»¶èŠ‚ç‚¹èŒƒå›´å†…çš„æœ€ç»ˆç”¨æˆ·æ“ä½œå¯ä»¥é€šè¿‡è°ƒç”¨ `nodeCreated()` æ–¹æ³•æ¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦è¢«åˆ›å»º. åªæœ‰å½“èŠ‚ç‚¹çš„æ¡ä»¶è¢«æ»¡è¶³ä¸”è¢«åˆ›å»ºä¸”è¢«æŽ¨å…¥åˆ°èŠ‚ç‚¹å †æ ˆä¸­æ—¶æ‰è¿”å›ž `true`, å¦åˆ™è¿”å›ž `false`. 

### å¼‚å¸¸å¤„ç†
ç”±èŠ‚ç‚¹ä½œç”¨åŸŸä¸­çš„æ‰©å±•æŠ›å‡ºçš„å¼‚å¸¸ä¸åœ¨è¯¥èŠ‚ç‚¹ä½œç”¨åŸŸå†…æ•èŽ·, ç”± JJTree æœ¬èº«æ•èŽ·. å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶, ä»»ä½•å·²è¢«åŽ‹å…¥èŠ‚ç‚¹èŒƒå›´å†…çš„å †æ ˆçš„èŠ‚ç‚¹éƒ½å°†è¢«å¼¹å‡ºå¹¶ä¸¢å¼ƒ. ç„¶åŽé‡æ–°æŠ›å‡ºå¼‚å¸¸. 

è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä½¿è§£æžå™¨èƒ½å¤Ÿå®žçŽ°é”™è¯¯æ¢å¤, å¹¶åœ¨å·²çŸ¥çŠ¶æ€ä¸‹ç»§ç»­ä½¿ç”¨èŠ‚ç‚¹å †æ ˆ. 

**æ³¨æ„: JJTree ç›®å‰æ— æ³•æ£€æµ‹èŠ‚ç‚¹ä½œç”¨åŸŸå†…çš„ç”¨æˆ·æ“ä½œæ˜¯å¦å¼•å‘å¼‚å¸¸. è¿™æ ·çš„å¼‚å¸¸å¯èƒ½ä¼šè¢«é”™è¯¯åœ°å¤„ç†.**

### èŠ‚ç‚¹ä½œç”¨åŸŸé’©å­
å¦‚æžœ `NODE_SCOPE_HOOK` è®¾ç½®ä¸º `true`, é‚£ä¹ˆ JJTree å°†åœ¨æ¯ä¸ªèŠ‚ç‚¹ä½œç”¨åŸŸçš„å…¥å£å’Œå‡ºå£ä¸Šç”Ÿæˆå¯¹ä¸¤ä¸ªç”¨æˆ·å®šä¹‰çš„è§£æžå™¨æ–¹æ³•çš„è°ƒç”¨. è¿™äº›æ–¹æ³•å¿…é¡»å…·æœ‰ä»¥ä¸‹å£°æ˜Ž:
```java
void jjtreeOpenNodeScope(Node n)
void jjtreeCloseNodeScope(Node n)
```

å¦‚æžœè§£æžå™¨æ˜¯ `STATIC`, é‚£ä¹ˆè¿™äº›æ–¹æ³•ä¹Ÿå¿…é¡»è¢«å£°æ˜Žä¸º `static`. å®ƒä»¬éƒ½ä»¥å½“å‰èŠ‚ç‚¹ä½œä¸ºå‚æ•°è°ƒç”¨. 

ä¸€ç§ç”¨é€”å¯èƒ½æ˜¯å°†è§£æžå™¨å¯¹è±¡æœ¬èº«å­˜å‚¨åœ¨èŠ‚ç‚¹ä¸­, ä»¥ä¾¿å¯ä»¥æä¾›åº”è¯¥ç”±è¯¥è§£æžå™¨ç”Ÿæˆçš„æ‰€æœ‰èŠ‚ç‚¹å…±äº«çš„çŠ¶æ€. ðŸŒ°, è§£æžå™¨å¯èƒ½ç»´æŠ¤ä¸€ä¸ªç¬¦å·è¡¨. 

```java
void jjtreeOpenNodeScope(Node n) {
	((SimpleNode)n).jjtSetValue(getSymbolTable());
}

void jjtreeCloseNodeScope(Node n) {}
```

å…¶ä¸­ `getSymbolTable()` æ˜¯ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„æ–¹æ³•, ç”¨æ¥è¿”å›žèŠ‚ç‚¹çš„ç¬¦å·è¡¨çš„ç»“æž„. 

### è·Ÿè¸ªä»¤ç‰Œ
è·Ÿè¸ªæ¯ä¸ªèŠ‚ç‚¹çš„æœ€åˆå’Œæœ€åŽçš„ä»¤ç‰Œé€šå¸¸å¾ˆæœ‰ç”¨, è¿™æ ·å°±å¯ä»¥è½»æ¾åœ°å†æ¬¡å¤åˆ¶è¾“å…¥. é€šè¿‡è®¾ç½® `TRACK_TOKENS` é€‰é¡¹, ç”Ÿæˆçš„ `SimpleNode` ç±»å°†åŒ…å« 4 ä¸ªé¢å¤–çš„æ–¹æ³•:
```java
public Token jjtGetFirstToken()
public void jjtSetFirstToken(Token token)
public Token jjtGetLastToken()
public void jjtSetLastToken(Token token)
```

å½“è§£æžå™¨è¿è¡Œçš„æ—¶å€™, å°†è‡ªåŠ¨è®¾ç½®æ¯ä¸ªèŠ‚ç‚¹çš„æœ€åˆå’Œæœ€åŽçš„ä»¤ç‰Œ. 

### èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸ
èŠ‚ç‚¹åœ¨åˆ›å»ºçš„æ—¶å€™å°†è¿›è¡Œä¸€ç³»åˆ—çš„ç¡®å®šçš„æ­¥éª¤. è¿™æ˜¯ä»ŽèŠ‚ç‚¹æœ¬èº«çš„è§’åº¦æ¥çœ‹çš„åºåˆ—:

1. ä½¿ç”¨å”¯ä¸€çš„æ•´æ•°å‚æ•°è°ƒç”¨èŠ‚ç‚¹çš„æž„é€ å‡½æ•°. æ­¤å‚æ•°æ ‡è¯†èŠ‚ç‚¹çš„ç±»åž‹, åœ¨ç®€å•æ¨¡å¼ä¸‹ç‰¹åˆ«æœ‰ç”¨. JJTree ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå«åš `&lt;parser&gt;TreeConstants.java` çš„æ–‡ä»¶, ç”¨æ¥å£°æ˜Žæœ‰æ•ˆå¸¸é‡. å¸¸é‡çš„å‘½åæ˜¯é€šè¿‡åœ¨èŠ‚ç‚¹çš„å¤§å†™åç§°å‰åŠ ä¸Š JJT æ¥æ´¾ç”Ÿçš„, ç‚¹ (`.`) æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ (`_`). ä¸ºæ–¹ä¾¿èµ·è§, åœ¨åŒä¸€æ–‡ä»¶ä¸­ç»´æŠ¤äº†ä¸€ä¸ªåä¸º `jjtNodeName[]` çš„å­—ç¬¦ä¸²æ•°ç»„, å®ƒå°†å¸¸é‡æ˜ å°„åˆ°æœªä¿®æ”¹çš„èŠ‚ç‚¹åç§°. 
2. èŠ‚ç‚¹çš„ `jjtOpen()` æ–¹æ³•è¢«è°ƒç”¨. 
3. å¦‚æžœè®¾ç½®äº† `NODE_SCOPE_HOOK` é€‰é¡¹, ç”¨æˆ·è‡ªå®šä¹‰è§£æžå™¨æ–¹æ³• `openNodeScope()` ä¼šè¢«è°ƒç”¨, å¹¶ä¸”èŠ‚ç‚¹ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’. è¯¥æ–¹æ³•å¯ä»¥åˆå§‹åŒ–èŠ‚ç‚¹ä¸­çš„å­—æ®µæˆ–è°ƒç”¨å…¶æ–¹æ³•. ðŸŒ°, å®ƒå¯ä»¥å­˜å‚¨èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªä»¤ç‰Œ. 
4. å¦‚æžœåœ¨è§£æžèŠ‚ç‚¹æ—¶æŠ›å‡ºæœªå¤„ç†çš„å¼‚å¸¸, åˆ™å°†è¯¥èŠ‚ç‚¹æŠ›å¼ƒ. JJTree å†ä¹Ÿä¸ä¼šå¼•ç”¨å®ƒäº†. å®ƒä¸ä¼šè¢«å…³é—­, å¹¶ä¸”**ä¸ä¼šä½¿ç”¨**å®ƒä½œä¸ºå‚æ•°æ¥è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„èŠ‚ç‚¹ä½œç”¨åŸŸé’©å­ `CloseNodeHook()`. 
5. å¦åˆ™, å¦‚æžœè¯¥èŠ‚ç‚¹æ˜¯æœ‰æ¡ä»¶çš„, å¹¶ä¸”å…¶æ¡ä»¶è¡¨è¾¾å¼çš„è®¡ç®—ç»“æžœä¸º `false`, åˆ™è¯¥èŠ‚ç‚¹å°†è¢«æ”¾å¼ƒ. å®ƒä¸ä¼šè¢«å…³é—­, å°½ç®¡**å¯ä»¥ä½¿ç”¨**å®ƒä½œä¸ºå‚æ•°è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„èŠ‚ç‚¹ä½œç”¨åŸŸé’©å­ `CloseNodeHook()`. 
6. å¦åˆ™, ç”±ç¡®å®šèŠ‚ç‚¹çš„æ•´æ•°è¡¨è¾¾å¼æŒ‡å®šçš„èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹, æˆ–åœ¨æ¡ä»¶èŠ‚ç‚¹èŒƒå›´å†…æŽ¨é€åˆ°å †æ ˆä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å°†æ·»åŠ åˆ°è¯¥èŠ‚ç‚¹. å®ƒä»¬æ·»åŠ çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„. 
7. èŠ‚ç‚¹çš„ `jjtClose()` æ–¹æ³•è¢«è°ƒç”¨. 
8. èŠ‚ç‚¹è¢«æŽ¨åˆ°å †æ ˆä¸­. 
9. å¦‚æžœè®¾ç½®äº† `NODE_SCOPE_HOOK` é€‰é¡¹, ç”¨æˆ·è‡ªå®šä¹‰è§£æžå™¨æ–¹æ³• `closeNodeScope()` ä¼šè¢«è°ƒç”¨, å¹¶ä¸”èŠ‚ç‚¹ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’.
10. å¦‚æžœèŠ‚ç‚¹ä¸æ˜¯æ ¹èŠ‚ç‚¹, é‚£ä¹ˆå®ƒå°†è¢«æ·»åŠ ä¸ºå¦ä¸€ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹, å¹¶è°ƒç”¨å…¶ `jjtSetParent()` æ–¹æ³•. 

### è®¿å®¢æ”¯æŒ
JJTree ä¸ºè®¿é—®è€…è®¾è®¡æ¨¡å¼æä¾›äº†ä¸€äº›åŸºæœ¬æ”¯æŒ. å¦‚æžœ `VISITOR` é€‰é¡¹è®¾ç½®ä¸º `true`, JJTree å°†æŠŠ `jjtAccept()` æ–¹æ³•æ’å…¥åˆ°å®ƒç”Ÿæˆçš„æ‰€æœ‰èŠ‚ç‚¹ç±»ä¸­, å¹¶ä¸”è¿˜ç”Ÿæˆå¯ä»¥å®žçŽ°å¹¶ä¼ é€’ç»™èŠ‚ç‚¹ä»¥æŽ¥å—çš„è®¿é—®è€…æŽ¥å£. 

è®¿é—®è€…æŽ¥å£çš„å‘½åæ˜¯é€šè¿‡å°† `Visitor` é™„åŠ åˆ°è§£æžå™¨çš„åç§°æ¥æž„é€ çš„. æ¯æ¬¡è¿è¡Œ JJTree æ—¶éƒ½ä¼šé‡æ–°ç”ŸæˆæŽ¥å£, ä»¥ä¾¿å‡†ç¡®è¡¨ç¤ºè§£æžå™¨ä½¿ç”¨çš„èŠ‚ç‚¹é›†. å¦‚æžœæ²¡æœ‰ä¸ºæ–°èŠ‚ç‚¹æ›´æ–°å®žçŽ°ç±», è¿™å°†å¯¼è‡´ç¼–è¯‘æ—¶é”™è¯¯. è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½. 

### é€‰é¡¹
| **é€‰é¡¹**                  | **ç¼ºçœå€¼**           | **æè¿°**                                                     |
| ------------------------- | -------------------- | ------------------------------------------------------------ |
| `BUILD_NODE_FILES`        | `true`               | ä¸º `SimpleNode` å’Œè¯­æ³•ä¸­ä½¿ç”¨çš„ä»»ä½•å…¶ä»–èŠ‚ç‚¹ç”Ÿæˆç¤ºä¾‹å®žçŽ°.      |
| `MULTI`                   | `false`              | ç”Ÿæˆå¤šæ¨¡å¼è§£æžæ ‘. ç¼ºçœå€¼ä¸º `false`, ç”Ÿæˆä¸€ä¸ªç®€å•æ¨¡å¼è§£æžæ ‘.  |
| `NODE_DEFAULT_VOID`       | `false`              | ä¸Žå…¶ä½¿æ¯ä¸ªæœªè£…é¥°çš„äº§å“æˆä¸ºä¸å®šèŠ‚ç‚¹, ä¸å¦‚ä½¿å…¶æ— æ•ˆ.            |
| `NODE_CLASS`              | `&#34;&#34;`                 | å¦‚æžœè®¾ç½®å®šä¹‰å°†æ‰©å±• `SimpleNode` çš„ç”¨æˆ·æä¾›çš„ç±»åç§°, é‚£ä¹ˆåˆ›å»ºçš„ä»»ä½•æ ‘èŠ‚ç‚¹éƒ½å°†æ˜¯ `NODE_CLASS` çš„å­ç±». |
| `NODE_FACTORY`            | `&#34;&#34;`                 | æŒ‡å®šä¸€ä¸ªåŒ…å«å·¥åŽ‚æ–¹æ³•çš„ç±», è¯¥æ–¹æ³•å…·æœ‰ä»¥ä¸‹ç­¾åä»¥æž„é€ èŠ‚ç‚¹: `public static Node jjtCreate(int id)`. ä¸ºäº†å‘åŽå…¼å®¹, ä¹Ÿå¯ä»¥æŒ‡å®šå€¼ `false`, è¿™æ„å‘³ç€ `SimpleNode` å°†ç”¨ä½œå·¥åŽ‚ç±». |
| `NODE_PACKAGE`            | `&#34;&#34;`                 | ç”ŸæˆèŠ‚ç‚¹ç±»çš„åŒ…. é»˜è®¤ä¸ºè§£æžå™¨åŒ….                              |
| `NODE_EXTENDS`            | `&#34;&#34;`                 | å¼ƒç”¨. `SimpleNode` ç±»çš„è¶…ç±». é€šè¿‡æä¾›è‡ªå®šä¹‰è¶…ç±», å¯ä»¥é¿å…ç¼–è¾‘ç”Ÿæˆçš„`SimpleNode.java`. |
| `NODE_PREFIX`             | `&#34;AST&#34;`              | ç”¨äºŽåœ¨å¤šæ¨¡å¼ä¸‹ä»ŽèŠ‚ç‚¹æ ‡è¯†ç¬¦æž„é€ èŠ‚ç‚¹ç±»åçš„å‰ç¼€.                |
| `NODE_SCOPE_HOOK`         | `false`              | åœ¨æ¯ä¸ªèŠ‚ç‚¹ä½œç”¨åŸŸçš„å…¥å£å’Œå‡ºå£ä¸Šç”Ÿæˆå¯¹ä¸¤ä¸ªç”¨æˆ·å®šä¹‰çš„è§£æžå™¨æ–¹æ³•çš„è°ƒç”¨. |
| `NODE_USES_PARSER`        | `false`              | JJTree å°†ä½¿ç”¨å¦ä¸€ç§å½¢å¼çš„èŠ‚ç‚¹æž„é€ ä¾‹ç¨‹, åœ¨å…¶ä¸­ä¼ é€’è§£æžå™¨å¯¹è±¡. ðŸŒ°: &lt;br/&gt;`public static Node MyNode.jjtCreate(MyParser p, int id);`&lt;br/&gt;`MyNode(MyParser p, int id);` |
| `TRACK_TOKENS`            | `false`              | åœ¨ `SimpleNode` ä¸­æ’å…¥ `jjtGetFirstToken()`, `jjtSetFirstToken()`, `getLastToken()` å’Œ `jjtSetLastToken()` æ–¹æ³•. `FirstToken` åœ¨è¿›å…¥èŠ‚ç‚¹ä½œç”¨åŸŸæ—¶è‡ªåŠ¨è®¾ç½®; `LastToken` åœ¨é€€å‡ºèŠ‚ç‚¹ä½œç”¨åŸŸæ—¶è‡ªåŠ¨è®¾ç½®. |
| `STATIC`                  | `true`               | ä¸ºé™æ€è§£æžå™¨ç”Ÿæˆä»£ç . è¿™å¿…é¡»ä¸Žç­‰æ•ˆçš„ JavaCC é€‰é¡¹ä¸€è‡´ä½¿ç”¨. è¯¥é€‰é¡¹çš„å€¼åœ¨ JavaCC æºä¸­å‘å‡º. |
| `VISITOR`                 | `false`              | åœ¨èŠ‚ç‚¹ç±»ä¸­æ’å…¥ä¸€ä¸ª `jjtAccept()` æ–¹æ³•, å¹¶ä¸ºè¯­æ³•ä¸­ä½¿ç”¨çš„æ¯ä¸ªèŠ‚ç‚¹ç±»åž‹ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¡ç›®çš„è®¿é—®è€…å®žçŽ°. |
| `VISITOR_DATA_TYPE`       | `&#34;Object&#34;`           | å¦‚æžœè®¾ç½®äº†è¯¥é€‰é¡¹, å®ƒå°†åœ¨ç”Ÿæˆçš„`jjtAccept()` æ–¹æ³•å’Œ `visit()` æ–¹æ³•çš„ç­¾åä¸­ç”¨ä½œæ•°æ®å‚æ•°çš„ç±»åž‹. |
| `VISITOR_RETURN_TYPE`     | `&#34;Object&#34;`           | å¦‚æžœè®¾ç½®äº†è¯¥é€‰é¡¹, å®ƒå°†åœ¨ç”Ÿæˆçš„`jjtAccept()` æ–¹æ³•å’Œ `visit()` æ–¹æ³•çš„ç­¾åä¸­ç”¨ä½œè¿”å›žå‚æ•°çš„ç±»åž‹. |
| `VISITOR_EXCEPTION`       | `&#34;&#34;`                 | å¦‚æžœè®¾ç½®äº†è¯¥é€‰é¡¹, å®ƒå°†åœ¨ç”Ÿæˆçš„`jjtAccept()` æ–¹æ³•å’Œ `visit()` æ–¹æ³•çš„ç­¾åä¸­. |
| `JJTREE_OUTPUT_DIRECTORY` | `&#34;OUTPUT_DIRECTORY&#34;` | é»˜è®¤æƒ…å†µä¸‹, JJTree åœ¨å…¨å±€ `OUTPUT_DIRECTORY` è®¾ç½®ä¸­æŒ‡å®šçš„ç›®å½•ä¸­ç”Ÿæˆå…¶è¾“å‡º. æ˜¾å¼è®¾ç½®æ­¤é€‰é¡¹å…è®¸ç”¨æˆ·å°†è§£æžå™¨ä¸Žæ ‘æ–‡ä»¶åˆ†å¼€. |

## JJTree æŽ¥å£

### JJTree çŠ¶æ€
JJTree å°†å…¶çŠ¶æ€ä¿å­˜åœ¨ä¸€ä¸ªåä¸º `jjtree` çš„è§£æžå™¨ç±»å­—æ®µä¸­. å¯ä»¥ä½¿ç”¨æ­¤æˆå‘˜ä¸­çš„æ–¹æ³•æ¥æ“ä½œèŠ‚ç‚¹å †æ ˆ. 

```java
final class JJTreeState {
	// è°ƒç”¨å®ƒæ¥é‡æ–°åˆå§‹åŒ–èŠ‚ç‚¹å †æ ˆ
	void reset();
	
	// è¿”å›žæŠ½è±¡è¯­æ³•æ ‘ (AST) çš„æ ¹èŠ‚ç‚¹
	Node rootNode();
	
	// åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦å®žé™…å…³é—­å¹¶æŽ¨é€
	boolean nodeCreated();
	
	// è¿”å›žèŠ‚ç‚¹ä¸Šå½“å‰æŽ¨é€çš„èŠ‚ç‚¹æ•°
	// å½“å‰èŠ‚ç‚¹ä½œç”¨åŸŸå†…çš„å †æ ˆ
	int arity();
	
	// æŽ¨é€èŠ‚ç‚¹åˆ°å †æ ˆ
	void pushNode(Node n);
	
	// è¿”å›žå †æ ˆé¡¶éƒ¨çš„èŠ‚ç‚¹, å¹¶å°†å…¶ä»Žå †æ ˆä¸­ç§»é™¤
	Node popNode();
	
	// è¿”å›žå½“å‰ä½äºŽå †æ ˆé¡¶éƒ¨çš„èŠ‚ç‚¹
	Node peekNode();
}
```

### èŠ‚ç‚¹å¯¹è±¡
```java
/**
	* æ‰€æœ‰ AST èŠ‚ç‚¹å¿…é¡»å®žçŽ°è¯¥æŽ¥å£.
	* å®ƒä¸ºæž„å»ºèŠ‚ç‚¹ä¹‹é—´çš„çˆ¶å­å…³ç³»æä¾›äº†åŸºæœ¬æœºåˆ¶.
	*/
public interface Node {
	// å°†èŠ‚ç‚¹è®¾ä¸ºå½“å‰èŠ‚ç‚¹åŽè°ƒç”¨æ­¤æ–¹æ³•.
	// è¡¨ç¤ºçŽ°åœ¨å¯ä»¥å‘å…¶ä¸­æ·»åŠ å­èŠ‚ç‚¹. 
	public void jjtOpen();
	
	// æ·»åŠ æ‰€æœ‰å­èŠ‚ç‚¹åŽè°ƒç”¨æ­¤æ–¹æ³•.
	public void jjtClose();
	
	// è¿™å¯¹æ–¹æ³•ç”¨äºŽé€šçŸ¥èŠ‚ç‚¹å…¶çˆ¶èŠ‚ç‚¹.
	public void jjtSetParent(Node n);
	public Node jjtGetParent();
	
	// æ­¤æ–¹æ³•é€šçŸ¥èŠ‚ç‚¹å°†å…¶å‚æ•°æ·»åŠ åˆ°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨ä¸­. 
	public void jjtAddChild(Node n, int i);
	
	// æ­¤æ–¹æ³•è¿”å›žå­èŠ‚ç‚¹.
	// å­èŠ‚ç‚¹ç¼–å·ä»Ž 0 å¼€å§‹, ä»Žå·¦è‡³å³.
	public Node jjtGetChild(int i);
	
	// è¿”å›žèŠ‚ç‚¹æ‹¥æœ‰çš„å­èŠ‚ç‚¹æ•°.
	int jjtGetNumChildren();
}
```

`SimpleNode` ç±»å®žçŽ°äº† `Node` æŽ¥å£, å¦‚æžœå®ƒä¸å­˜åœ¨, åˆ™ç”± JJTree è‡ªåŠ¨ç”Ÿæˆ. å¯ä»¥ä½¿ç”¨è¯¥ç±»ä½œä¸ºèŠ‚ç‚¹å®žçŽ°çš„æ¨¡æ¿æˆ–è¶…ç±», æˆ–ä¿®æ”¹å…¶è¿›è¡Œé€‚é…. `SimpleNode` è¿˜æä¾›äº†é€’å½’è½¬å‚¨èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹çš„åŸºæœ¬æœºåˆ¶. 

å¯ä»¥åƒè¿™æ ·ä½¿ç”¨è¿™ä¸ªå‘½ä»¤: 
```java
{
	((SimpleNode)jjtree.rootNode()).dump(&#34;&gt;&#34;);
}
```

`dump()` çš„å­—ç¬¦ä¸²å‚æ•°ç”¨ä½œå¡«å……, ä»¥æŒ‡ç¤ºæ ‘å±‚æ¬¡ç»“æž„. 

å¦‚æžœè®¾ç½®äº† `VISITOR` é€‰é¡¹, åˆ™ä¼šç”Ÿæˆå¦ä¸€ä¸ªå®žç”¨ç¨‹åºæ–¹æ³•: 
```java
{
	public void childrenAccept(MyParserVisitor visitor);
}
```

è¿™ä¼šè½®æµéåŽ†èŠ‚ç‚¹çš„å­èŠ‚ç‚¹, è¦æ±‚å®ƒä»¬æŽ¥å—è®¿é—®è€…. è¿™åœ¨å®žçŽ°å‰åºå’ŒåŽåºéåŽ†æ—¶å¾ˆæœ‰ç”¨. 


---

> ä½œè€…:   
> URL: https://buli-home.cn/jjtree/  

