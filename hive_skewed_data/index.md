# Hive çš„æ•°æ®å€¾æ–œé—®é¢˜


&lt;!--more--&gt;



&gt; åœ¨æ—¥å¸¸ä½¿ç”¨ Hive çš„è¿‡ç¨‹ä¸­, ç»å¸¸ä¼šå‡ºçŽ°è¿™æ ·ä¸€ç§åœºæ™¯: æ˜Žæ˜ŽæŸ¥è¯¢çš„æ—¶å€™è¿›åº¦æ¡å¾ˆå¿«, ä½†æ˜¯æ€»æ˜¯ä¼šå¡åœ¨ 99% çš„åœ°æ–¹. å‡ºçŽ°è¿™ç§æƒ…å†µå¾€å¾€å°±æ˜¯å› ä¸ºæ•°æ®å€¾æ–œå¯¼è‡´çš„. 



## ä»€ä¹ˆæ˜¯æ•°æ®å€¾æ–œ

æ•°æ®å€¾æ–œåœ¨ MapReduce ä¸­ç»å¸¸å‘ç”Ÿçš„. ç®€å•ç‚¹è¯´å°±æ˜¯, åœ¨æ•´ä¸ªè®¡ç®—è¿‡ç¨‹ä¸­, å¤§é‡ç›¸åŒçš„ key è¢«åˆ†é…åˆ°äº†åŒä¸€ä¸ªä»»åŠ¡ä¸Š, é€ æˆäº†å¤§é‡çš„æ•°æ®æ¶Œå…¥åˆ°ä¸€ä¸ªèŠ‚ç‚¹å½“ä¸­. è¿™ä¹Ÿè¿èƒŒäº†åˆ†å¸ƒå¼è®¡ç®—çš„åˆè¡·, ä½¿å¾—è®¡ç®—çš„æ•´ä½“æ‰§è¡Œæ•ˆçŽ‡ååˆ†ä½Žä¸‹. 



æ•°æ®å€¾æ–œåŽçš„ç›´è§‚è¡¨çŽ°å°±æ˜¯ä»»åŠ¡è¿›åº¦é•¿æ—¶é—´ç»´æŒåœ¨ 99% (æˆ–100%), æŸ¥çœ‹ç›‘æŽ§ä¹‹åŽä¼šå‘çŽ°åªæœ‰å°‘é‡çš„ Reduce å­ä»»åŠ¡æœªå®Œæˆ. å› ä¸ºå…¶å¤„ç†çš„æ•°æ®é‡å’Œå…¶ä»–çš„ Reduce å­ä»»åŠ¡å·®å¼‚è¿‡å¤§, é€ æˆæœ€é•¿æ—¶é•¿è¿œå¤§äºŽå¹³å‡æ—¶é•¿. 



## ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºçŽ°æ•°æ®å€¾æ–œ

åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­æ•°æ®å€¾æ–œä¸»è¦æ˜¯å‘ç”Ÿåœ¨ Reduce é˜¶æ®µ, å¾ˆå°‘ä¼šå‘ç”Ÿåœ¨ Map é˜¶æ®µ, å› ä¸º Map é˜¶æ®µçš„æ•°æ®å€¾æ–œä¸€èˆ¬æ˜¯ç”±äºŽ HDFS æ•°æ®å­˜å‚¨ä¸å‡åŒ€é€ æˆçš„(ä¸€èˆ¬å­˜å‚¨éƒ½æ˜¯å‡åŒ€åˆ†å—å­˜å‚¨, æ¯ä¸ªæ–‡ä»¶å¤§å°åŸºæœ¬å›ºå®š), è€Œ Reduce é˜¶æ®µçš„æ•°æ®å€¾æ–œå‡ ä¹Žéƒ½æ˜¯å› ä¸ºæ•°æ®æ²¡æœ‰è€ƒè™‘åˆ°æŸç§ key å€¼æ•°æ®é‡åå¤šçš„æƒ…å†µè€Œå¯¼è‡´çš„. 



Reduce é˜¶æ®µæœ€å®¹æ˜“å‡ºçŽ°æ•°æ®å€¾æ–œçš„ä¸¤ä¸ªåœºæ™¯åˆ†åˆ«æ˜¯ Join å’Œ Count Distinct. 



## æ•°æ®å€¾æ–œçš„åŽŸå› 

* key åˆ†å¸ƒä¸å‡åŒ€
* ä¸šåŠ¡æ•°æ®æœ¬èº«çš„ç‰¹æ€§
* å»ºè¡¨æ—¶è€ƒè™‘ä¸å‘¨
* æŸäº› SQL è¯­å¥æœ¬èº«å°±æœ‰æ•°æ®å€¾æ–œ



## æ•°æ®å€¾æ–œçš„è§£å†³æ–¹æ¡ˆ

### ä¼˜å…ˆå¼€å¯è´Ÿè½½å‡è¡¡

```bash
-- map ç«¯çš„ Combiner, é»˜è®¤ä¸º true
set hive.map.aggr=true;
-- å¼€å¯è´Ÿè½½å‡è¡¡ (é»˜è®¤ä¸º false)
set hive.groupby.skewindata=true;
```



å¦‚æžœå‘ç”Ÿæ•°æ®å€¾æ–œ, é¦–å…ˆéœ€è¦è°ƒæ•´å‚æ•°, è¿›è¡Œè´Ÿè½½å‡è¡¡å¤„ç†, è¿™æ · MapReduce è¿›ç¨‹åˆ™ä¼šç”Ÿæˆä¸¤ä¸ªé¢å¤–çš„ MR Job, è¿™ä¸¤ä¸ªä»»åŠ¡çš„ä¸»è¦æ“ä½œå¦‚ä¸‹: 

1. MR Job ä¸­ Map è¾“å‡ºçš„ç»“æžœé›†é¦–å…ˆä¼šéšæœºåˆ†é…åˆ° Reduce ä¸­, ç„¶åŽæ¯ä¸ª Reduce åšå±€éƒ¨èšåˆæ“ä½œå¹¶è¾“å‡ºç»“æžœ, è¿™æ ·å¤„ç†çš„åŽŸå› æ˜¯ç›¸åŒçš„ Group By Key æœ‰å¯èƒ½è¢«åˆ†å‘åˆ°ä¸åŒçš„ Reduce Job ä¸­, ä»Žè€Œè¾¾åˆ°è´Ÿè½½å‡è¡¡çš„ç›®çš„. 
2. MR Job å†æ ¹æ®é¢„å¤„ç†çš„æ•°æ®ç»“æžœæŒ‰ç…§ Group By Key åˆ†å¸ƒåˆ° Reduce ä¸­ (è¿™ä¸ªè¿‡ç¨‹ä¼šä¿è¯ç›¸åŒçš„ Group By Key è¢«åˆ†ä¸åˆ°åŒä¸€ä¸ª Reduce ä¸­), æœ€åŽå®Œæˆèšåˆ. 



### è¡¨ join è¿žæŽ¥æ—¶å¼•å‘çš„æ•°æ®å€¾æ–œ

ä¸¤ä¸ªè¡¨è¿›è¡Œ join æ—¶, å¦‚æžœè¡¨è¿žæŽ¥çš„ key å­˜åœ¨å€¾æ–œ, é‚£ä¹ˆåœ¨ Shuffle é˜¶æ®µå¿…ç„¶ä¼šå¼•èµ·æ•°æ®å€¾æ–œ

#### å°è¡¨ join å¤§è¡¨, æŸä¸ª key è¿‡å¤§

é€šå¸¸åšæ³•æ˜¯å°†å€¾æ–œçš„æ•°æ®å­˜åˆ°åˆ†å¸ƒå¼ç¼“å­˜ä¸­, åˆ†å‘åˆ°å„ä¸ª Map ä»»åŠ¡æ‰€åœ¨èŠ‚ç‚¹. åœ¨ Map é˜¶æ®µå®Œæˆ join æ“ä½œ, å³ MapJoin, è¿™æ ·å°±é¿å…äº† Shuffle, ä»Žè€Œé¿å…äº†æ•°æ®å€¾æ–œ. 



MapJoin æ˜¯ Hive çš„ä¸€ç§ä¼˜åŒ–æ“ä½œ, å…¶é€‚ç”¨äºŽå°è¡¨ Join å¤§è¡¨çš„åœºæ™¯, ç”±äºŽè¡¨çš„ Join æ“ä½œæ˜¯åœ¨ Map ç«¯ä¸”åœ¨å†…å­˜å°½æƒ…çš„, æ‰€ä»¥å…¶å¹¶ä¸éœ€è¦å¯åŠ¨ Reduce ä»»åŠ¡ä¹Ÿå°±ä¸éœ€è¦ç»è¿‡ Shuffle é˜¶æ®µ, ä»Žè€Œèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸ŠèŠ‚çœèµ„æºæé«˜ Join æ•ˆçŽ‡. 



åœ¨ Hive v0.11 ä¹‹å‰, å¦‚æžœæƒ³åœ¨ Map é˜¶æ®µå®Œæˆ join æ“ä½œ, å¿…é¡»ä½¿ç”¨ MAPJOIN æ¥æ ‡è®°æ˜¾å¼çš„å¯åŠ¨è¯¥ä¼˜åŒ–æ“ä½œ, ç”±äºŽå…¶éœ€è¦å°†å°è¡¨åŠ è½½è¿›å†…å­˜æ‰€ä»¥è¦æ³¨æ„å°è¡¨çš„å¤§å°. 



```sql
-- å¸¸è§„ join
SELECT 
	pis.id_ id,
	service_name serviceName,
	service_code serviceCode,
	pip.code_text serviceType
FROM
	prd_price_increment_service pis
	LEFT JOIN prd_price_increment_product pip on pip.increment_service_id = pis.id_;
	
-- Hive v0.11 ä¹‹å‰å¼€å¯ MapJoin
-- å°†å°è¡¨ prd_price_increment_service æ”¾åˆ° map ç«¯çš„å†…å­˜ä¸­
-- å¦‚æžœæƒ³å°†å¤šä¸ªè¡¨æ”¾åœ¨ Map ç«¯å†…å­˜ä¸­, åªéœ€åœ¨ mapjoin() ä¸­å†™å¤šä¸ªè¡¨åç§°å³å¯, ç”¨é€—å·åˆ†å‰²
SELECT
	/*&#43; mapjoin(pis) */
	pis.id_ id,
	service_name serviceName,
	service_code serviceCode,
	pip.code_text serviceType
FROM
	prd_price_increment_service pis
	LEFT JOIN prd_price_increment_product pip on pip.increment_service_id = pis.id_;
```



åœ¨ v0.11 åŠä¹‹åŽ, Hive é»˜è®¤å¯åŠ¨è¯¥ä¼˜åŒ–, ä¸éœ€è¦æ˜¾å¼çš„ä½¿ç”¨ MAPJOIN æ ‡è®°, å¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ä¸ªå±žæ€§æ¥è®¾ç½®è¯¥ä¼˜åŒ–çš„å‡ºå‘æ—¶æœº:

```sql
-- è‡ªåŠ¨å¼€å¯ MAPJOIN ä¼˜åŒ–, é»˜è®¤ä¸º true
set hive.auto.convert.join=true;
-- ç¡®å®šä½¿ç”¨è¯¥ä¼˜åŒ–çš„è¡¨çš„å¤§å°, å¦‚æžœè¡¨çš„å¤§å°å°äºŽæ­¤å€¼å°±ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­, é»˜è®¤ä¸º 25000000 (25M)
set hive.mapjoin.smalltable.filesize=25000000;

SELECT 
	pis.id_ id,
	service_name serviceName,
	service_code serviceCode,
	pip.code_text serviceType
FROM
	prd_price_increment_service pis
	LEFT JOIN prd_price_increment_product pip on pip.increment_service_id = pis.id_;
	
-- ç‰¹æ®Šè¯´æ˜Ž
-- ä½¿ç”¨é»˜è®¤å¯åŠ¨è¯¥ä¼˜åŒ–çš„æ–¹å¼å¦‚æžœå‡ºçŽ°èŽ«åå…¶å¦™çš„ bug (æ¯”å¦‚ MAPJOIN ä¸èµ·ä½œç”¨), å°±å°†ä»¥ä¸‹ä¸¤ä¸ªå±žæ€§ç½®ä¸º false
-- 
-- å…³é—­è‡ªåŠ¨ MAPJOIN è½¬æ¢æ“ä½œ
set hive.auto.convert.join=false;
-- ä¸å¿½ç•¥ MAPJOIN æ ‡è®°
set hive.ignore.mapjoin.hint=false;

SELECT
	/*&#43; mapjoin(pis) */
	pis.id_ id,
	service_name serviceName,
	service_code serviceCode,
	pip.code_text serviceType
FROM
	prd_price_increment_service pis
	LEFT JOIN prd_price_increment_product pip on pip.increment_service_id = pis.id_;
```



&gt; å°†è¡¨æ”¾åœ¨ Map ç«¯çš„å†…å­˜æ—¶, å¦‚æžœèŠ‚ç‚¹çš„å†…å­˜å¾ˆå¤§, ä½†è¿˜æ˜¯å‡ºçŽ°å†…å­˜æº¢å‡ºçš„æƒ…å†µ, å¯ä»¥é€šè¿‡å‚æ•° `mapreduce.map.memory.mb` è°ƒèŠ‚ Map ç«¯å†…å­˜çš„å¤§å°. 



#### è¡¨ä¸­ä½œä¸ºå…³è”æ¡ä»¶çš„å­—æ®µå€¼ä¸º 0 æˆ–ç©ºå€¼çš„è¾ƒå¤š

```sql
-- æ–¹æ¡ˆä¸€: ç»™ç©ºå€¼æ·»åŠ éšæœº key å€¼, å°†å…¶å‘æ”¾åˆ°ä¸åŒçš„ reduce ä¸­å¤„ç†. ç”±äºŽ null å€¼å…³è”ä¸ä¸Š, æ‰€ä»¥å¯¹ç»“æžœæ— å½±å“. 
SELECT 
	*
FROM log a
LEFT JOIN users b
ON (CASE WHEN a.user_id IS NULL THEN CONCAT(&#39;hive&#39;, rand()) ELSE a.user_id END) = b.user_id;

-- æ–¹æ¡ˆäºŒ: åŽ»é‡ç©ºå€¼
SELECT 
	a.*,
	b.name
FROM (
	SELECT * FROM users WHERE LENGTH(user_id) &gt; 1 OR user_id IS NOT NULL
) a
JOIN (
	SELECT * FROM log WHERE LENGTH(user_id) &gt; 1 OR user_id IS NOT NULL
) b
ON a.user_id = b.user_id;
```


#### è¡¨ä¸­ä½œä¸ºå…³è”æ¡ä»¶çš„å­—æ®µé‡å¤å€¼è¿‡å¤š

```sql
SELECT 
	a.*,
	b.name
FROM (
	SELECT * FROM users WHERE LENGTH(user_id) &gt; 1 OR user_id IS NOT NULL) a
) a
JOIN (
	SELECT * FROM (SELECT *, row_number() over(partition by user_id order by create_time desc) rk FROM log WHERE LENGTH(user_id) &gt; 1 OR user_id IS NOT NULL) t where rk = 1
) b
```


### ç©ºå€¼å¼•å‘çš„æ•°æ®å€¾æ–œ

å®žé™…ä¸šåŠ¡ä¸­æœ‰äº›å¤§é‡çš„ `null` å€¼æˆ–è€…ä¸€äº›æ— æ„ä¹‰çš„æ•°æ®å‚ä¸Žåˆ°è®¡ç®—ä½œä¸šä¸­, è¡¨ä¸­æœ‰å¤§é‡çš„ `null` å€¼, å¦‚æžœè¡¨ä¹‹é—´è¿›è¡Œ JOIN æ“ä½œ, å°±ä¼šæœ‰ Shuffle äº§ç”Ÿ, è¿™æ ·æ‰€æœ‰çš„ `null` å€¼éƒ½ä¼šè¢«åˆ†é…åˆ°ä¸€ä¸ª reduce ä¸­, æ‰€ä»¥å°±ä¸€å®šä¼šäº§ç”Ÿæ•°æ®å€¾æ–œ. 

è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜: å¦‚æžœ A, B ä¸¤è¡¨è¿›è¡Œ JOIN æ“ä½œ, å¦‚æžœ A è¡¨ä¸­éœ€è¦ JOIN çš„å­—æ®µä¸º `null`, ä½†æ˜¯ B è¡¨ä¸­éœ€è¦ JOIN çš„å­—æ®µä¸ä¸º `null`, è¿™ä¸¤ä¸ªå­—æ®µæ ¹æœ¬å°± JOIN éƒ¨ä¸Š, ä½†æ˜¯è¿˜æ˜¯ä¼šæ”¾åˆ°ä¸€ä¸ª reduce ä¸­. è¿™æ˜¯å› ä¸º, æ•°æ®æ”¾åˆ°åŒä¸€ä¸ª reduce ä¸­çš„åŽŸå› ä¸æ˜¯å› ä¸ºå­—æ®µèƒ½ä¸èƒ½ JOIN ä¸Š, è€Œæ˜¯å› ä¸º Shuffle é˜¶æ®µçš„ hash æ“ä½œ, åªæœ‰ key çš„ hash æ˜¯ä¸€æ ·çš„, å°±ä¼šè¢«æ”¾åˆ°åŒä¸€ä¸ª reduce ä¸­. 

```sql
-- è§£å†³æ–¹æ¡ˆ
-- åœºæ™¯: ðŸŒ° æ—¥å¿—ä¸­, ç»å¸¸ä¼šæœ‰ä¿¡æ¯ä¸¢å¤±çš„é—®é¢˜, æ¯”å¦‚æ—¥å¿—ä¸­çš„ user_id, å¦‚æžœå–å…¶ä¸­çš„ user_id å’Œç”¨æˆ·è¡¨ä¸­çš„ user_id å…³è”, ä¼šç¢°åˆ°æ•°æ®å€¾æ–œçš„é—®é¢˜
-- æ–¹æ¡ˆä¸€: å¯ä»¥ç›´æŽ¥ä¸è®© null å€¼å‚ä¸Ž JOIN æ“ä½œ, å³ä¸è®© null å€¼æœ‰ Shuffle é˜¶æ®µ, æ‰€ä»¥ user_id ä¸ºç©ºçš„ä¸å‚ä¸Žå…³è”
SELECT 
	*
FROM log a 
JOIN users b
ON a.user_id IS NOT NULL AND a.user_id = b.user_id
UNION ALL
SELECT 
	*
FROM log a 
WHERE a.user_id IS NULL;

-- æ–¹æ¡ˆäºŒ: å› ä¸º null å€¼å‚ä¸Ž Shuffle æ—¶çš„ hash ç»“æžœæ˜¯ä¸€æ ·çš„, é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç»™ null å€¼éšæœºèµ‹å€¼, è¿™æ ·å®ƒä»¬çš„ hash ç»“æžœå°±ä¸ä¸€è‡´, å°±ä¼šè¿›åˆ°ä¸åŒçš„ reduce ä¸­
SELECT
	*
FROM log a
LEFT JOIN users b
ON (CASE WHEN a.user_id IS NULL THEN CONCAT(&#39;hvie_&#39;, rand()) ELSE a.user_id END) = b.user_id
```

&gt; é’ˆå¯¹ä¸Šè¿°æ–¹æ¡ˆè¿›è¡Œåˆ†æž, æ–¹æ¡ˆäºŒæ¯”æ–¹æ¡ˆä¸€çš„æ•ˆçŽ‡æ›´é«˜, ä¸ä½† IO å°‘äº†, è€Œä¸”ä½œä¸šæ•°ä¹Ÿå°‘äº†. æ–¹æ¡ˆä¸€ä¸­å¯¹ log è¯»å–ä¸¤æ¬¡,  jobs ä¸º 2. æ–¹æ¡ˆäºŒ job æ•°æ˜¯ 1. è¿™ä¸ªä¼˜åŒ–é€‚åˆå¯¹æ— æ•ˆ id (-99, &#39;&#39;, null ç­‰) äº§ç”Ÿçš„å€¾æ–œé—®é¢˜. æŠŠç©ºå€¼çš„ key å˜æˆä¸€ä¸ªå­—ç¬¦ä¸²åŠ ä¸Šéšæœºæ•°, å°±èƒ½æŠŠå€¾æ–œçš„æ•°æ®åˆ†åˆ°ä¸åŒçš„ reduce ä¸Š, ä»Žè€Œè§£å†³å€¾æ–œçš„é—®é¢˜. 


### ä¸åŒæ•°æ®ç±»åž‹å…³è”äº§ç”Ÿæ•°æ®å€¾æ–œ

å¯¹äºŽä¸¤ä¸ªè¡¨ JOIN, è¡¨ a ä¸­éœ€è¦ JOIN çš„å­—æ®µ key ä¸º int, è¡¨ b ä¸­ key å­—æ®µæ—¢æœ‰ string ç±»åž‹ä¹Ÿæœ‰ int ç±»åž‹. å½“æŒ‰ç…§ key è¿›è¡Œä¸¤ä¸ªè¡¨çš„ JOIN æ“ä½œæ—¶, é»˜è®¤çš„ hash æ“ä½œä¼šæŒ‰ int ç±»åž‹çš„ id æ¥è¿›è¡Œåˆ†é…, è¿™æ ·æ‰€æœ‰çš„ string ç±»åž‹éƒ½å°†åˆ†é…æˆåŒä¸€ä¸ª id, ç»“æžœå°±æ˜¯æ‰€æœ‰çš„ string ç±»åž‹çš„å­—æ®µè¿›å…¥åˆ°ä¸€ä¸ª reduce ä¸­, ä»Žè€Œé€ æˆæ•°æ®å€¾æ–œ. 

```sql
-- å¦‚æžœ key å­—æ®µæ—¢æœ‰ string ç±»åž‹ä¹Ÿæœ‰ int ç±»åž‹, é‚£ä¹ˆå°±ç›´æŽ¥éƒ½è½¬æˆ string ç±»åž‹, hash æ—¶å°±ä¼šæŒ‰ç…§ string ç±»åž‹åˆ†é…äº†
-- æ–¹æ¡ˆä¸€: æŠŠæ•°å­—ç±»åž‹è½¬æˆå­—ç¬¦ä¸²ç±»åž‹
SELECT * FROM users a LEFT JOIN logs b ON a.user_id = CAST(b.user_id AS string);

-- æ–¹æ¡ˆäºŒ: å»ºè¡¨æ—¶æŒ‰ç…§è§„èŒƒå»ºè®¾, ç»Ÿä¸€è¯æ ¹, åŒä¸€è¯æ ¹æ•°æ®ç±»åž‹ä¸€è‡´
```


### COUNT DISTINCT å¤§é‡ç›¸åŒç‰¹æ®Šå€¼

ç”±äºŽ SQL ä¸­çš„ DISTINCT æ“ä½œæœ¬èº«ä¼šæœ‰ä¸€ä¸ªå…¨å±€æŽ’åºçš„è¿‡ç¨‹, ä¸€èˆ¬æƒ…å†µä¸‹, ä¸å»ºè®®é‡‡ç”¨ COUNT DISTINCT æ–¹å¼è¿›è¡ŒåŽ»é‡è®¡æ•°, é™¤éžè¡¨çš„æ•°é‡è¾ƒå°. 

* å½“ SQL ä¸­ä¸å­˜åœ¨åˆ†ç»„å­—æ®µæ—¶, COUNT DISTINCT æ“ä½œä»…ç”Ÿæˆä¸€ä¸ª reduce ä»»åŠ¡, è¯¥ä»»åŠ¡å¯¹å…¨éƒ¨æ•°æ®è¿›è¡ŒåŽ»é‡ç»Ÿè®¡; 
* å½“ SQL ä¸­å­˜åœ¨åˆ†ç»„å­—æ®µæ—¶, å¯èƒ½æŸäº› reduce ä»»åŠ¡éœ€è¦åŽ»é‡ç»Ÿè®¡çš„æ•°é‡éžå¸¸å¤§;

```sql
-- å¯èƒ½é€ æˆå€¾æ–œçš„ SQL
SELECT a, COUNT(DISTINCT b) FROM t GROUP BY a;

-- å…ˆåŽ»é‡, ç„¶åŽåˆ†ç»„ç»Ÿè®¡
SELECT a, sum(1) FROM (SELECT a, b FROM t GROUP BY a, b) GROUP BY a;
```

&gt; æ€»ç»“: å¦‚æžœåˆ†ç»„ç»Ÿè®¡çš„æ•°æ®å­˜åœ¨å¤šä¸ª DISTINCT ç»“æžœ, å¯ä»¥å…ˆå°†æ•°å€¼ä¸ºç©ºçš„æ•°æ®å ä½å¤„ç†, åˆ† SQL ç»Ÿè®¡æ•°æ®, ç„¶åŽå°†ä¸¤ç»„ç»“æžœ UNION ALL è¿›è¡Œæ±‡æ€»ç»“ç®—. 


### æ•°æ®è†¨èƒ€å¼•å‘çš„æ•°æ®å€¾æ–œ

åœ¨å¤šç»´èšåˆè®¡ç®—æ—¶, å¦‚æžœè¿›è¡Œåˆ†ç»„èšåˆçš„å­—æ®µè¿‡å¤š, ä¸”æ•°æ®é‡å¾ˆå¤§, map ç«¯çš„èšåˆä¸èƒ½å¾ˆå¥½åœ°èµ·åˆ°æ•°æ®åŽ‹ç¼©çš„æƒ…å†µä¸‹, ä¼šå¯¼è‡´ map äº§å‡ºçš„æ•°æ®æ€¥é€Ÿè†¨èƒ€, è¿™ç§æƒ…å†µå®¹æ˜“å¯¼è‡´ä½œä¸šå†…å­˜æº¢å‡ºçš„å¼‚å¸¸. å¦‚æžœ log è¡¨å«æœ‰æ•°æ®å€¾æ–œ key, ä¼šå®¶å…· Shuffle è¿‡ç¨‹çš„å€¾æ–œ. 

```sql
-- é€ æˆå€¾æ–œæˆ–å†…å­˜æº¢å‡ºçš„æƒ…å†µ
-- SQL 01
SELECT a, b, c, COUNT(1) FROM log GROUP BY  a, b, c WITH ROLLUP;
-- SQL 02
SELECT a, b, c, COUNT(1) FROM log GROUPING SETS a, b, c;

-- è§£å†³æ–¹æ¡ˆ
-- å¯ä»¥æ‹†åˆ†ä¸Šé¢çš„ SQL, å°† WITH ROLLUP æ‹†åˆ†æˆå‡ ä¸ª SQL
SELECT 
	a, b, c sum(1)
FROM (
	SELECT a, b, c COUNT(1) FROM log GROUP BY a, b, c
	UNION ALL
	SELECT a, b, NULL, COUNT(1) FROM log GROUP BY a, b
	UNION ALL
	SELECT a, NULL, NULL, COUNT(1) FROM log GROUP BY a
	UNION ALL
	SELECT NULL, NULL, NULL COUNT(1) FROM log 
) t;
-- ä½†æ˜¯è¿™ç§æ–¹å¼ä¸å¤ªå‹å¥½, å› ä¸ºè¿™æ˜¯å¯¹ 3 ä¸ªå­—æ®µè¿›è¡Œåˆ†ç»„èšåˆ, ä½†å¦‚æžœæ˜¯æ›´å¤šçš„å­—æ®µå°±å¾ˆéº»çƒ¦äº†. 

-- åœ¨ Hive ä¸­å¯ä»¥é€šè¿‡å‚æ•° hive.new.job.grouping.set.cardinality é…ç½®çš„æ–¹å¼è‡ªåŠ¨æŽ§åˆ¶ä½œä¸šçš„æ‹†è§£, è¯¥å‚æ•°é»˜è®¤å€¼æ˜¯ 30
-- è¯¥å‚æ•°ä¸»è¦é’ˆå¯¹ GROUPING SETS/ROLLUPS/CUBES è¿™ç±»å¤šç»´èšåˆçš„æ“ä½œç”Ÿæ•ˆ, å¦‚æžœæœ€åŽæ‹†è§£çš„é”®ç»„åˆå¤§äºŽè¯¥å€¼, ä¼šå¯ç”¨æ–°çš„ä»»åŠ¡åŽ»å¤„ç†å¤§äºŽè¯¥å€¼ä¹‹å¤–çš„ç»„åˆ. å¦‚æžœåœ¨å¤„ç†æ•°æ®æ—¶, æŸä¸ªåˆ†ç»„èšåˆçš„åˆ—æœ‰è¾ƒå¤§çš„å€¾æ–œ, å¯ä»¥é€‚å½“è°ƒå°è¯¥å€¼. 
set hive.new.job.grouping.set.cardinality=10;
SELECT a, b, c, count(1) FROM log GROUP BY a, b, c, WITH ROLLUP;
```


## æ€»ç»“

è¯´åˆ°åº•, è§£å†³ reduce ç«¯æ•°æ®å€¾æ–œçš„å¿…ç„¶é€”å¾„å°±æ˜¯è®© map ç«¯çš„è¾“å‡ºæ•°æ®æ›´å‡åŒ€åœ°åˆ†å¸ƒåˆ° reduce ä¸­. 

åœ¨æ­¤è¿‡ç¨‹ä¸­, æŽŒæ¡å››ç‚¹å¯ä»¥æ›´å¥½çš„è§£å†³æ•°æ®å€¾æ–œé—®é¢˜: 

1. å¦‚æžœä»»åŠ¡é•¿æ—¶é—´å¡åœ¨ 99% åˆ™åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯å‘ç”Ÿäº†æ•°æ®å€¾æ–œ, å»ºè®®è°ƒæ•´å‚æ•°ä»¥å®žçŽ°è´Ÿè½½å‡è¡¡: `set hive.groupby.skewindata=true`
2. å°è¡¨å…³è”å¤§è¡¨æ“ä½œ, éœ€è¦å…ˆçœ‹èƒ½å¦ä½¿ç”¨å­æŸ¥è¯¢, å†çœ‹èƒ½å¦ä½¿ç”¨ MAPJOIN
3. JOIN æ“ä½œæ³¨æ„å…³è”å­—æ®µä¸èƒ½å‡ºçŽ°å¤§é‡çš„é‡å¤å€¼æˆ–è€…ç©ºå€¼
4. COUNT(DISTINCT id) åŽ»é‡ç»Ÿè®¡ç”¨æ…Žç”¨, å°½é‡é€šè¿‡å…¶å®ƒæ–¹å¼æ›¿æ¢


---

> ä½œè€…:   
> URL: https://buli-home.cn/hive_skewed_data/  

